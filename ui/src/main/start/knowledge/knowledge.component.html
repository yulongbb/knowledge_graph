<div class="knowledge-page">
  <!-- 搜索框和导航栏在所有布局中都显示 -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search search-icon"></i>
      <input type="text" [(ngModel)]="searchText" placeholder="搜索知识..." (keyup.enter)="onSearch()"
        [ngStyle]="{'padding-right': searchText ? '40px' : '20px'}">
      <i class="fas fa-times clear-icon" *ngIf="searchText" (click)="clearSearch()"></i>
    </div>
  </div>

  <app-knowledge-nav [categories]="categories" (categorySelected)="onCategorySelected($event)">
  </app-knowledge-nav>

  <!-- 游戏类型布局 -->
  <ng-container *ngIf="isGamesCategory(); else sportsLayout">
    <div class="games-layout">
      <app-knowledge-games></app-knowledge-games>
    </div>
  </ng-container>

  <!-- 体育或其他布局 -->
  <ng-template #sportsLayout>
    <!-- 体育类型布局 -->
    <ng-container *ngIf="isSportsCategory(); else aiToolsLayout">
      <div class="sports-layout">
        <app-knowledge-sports></app-knowledge-sports>
      </div>
    </ng-container>

    <!-- AI工具或其他布局 -->
    <ng-template #aiToolsLayout>
      <!-- AI工具类型布局 -->
      <ng-container *ngIf="isAiToolsCategory(); else navigationLayout">
        <div class="ai-tools-layout">
          <app-knowledge-ai-tools></app-knowledge-ai-tools>
        </div>
      </ng-container>

      <!-- 导航或其他布局 -->
      <ng-template #navigationLayout>
        <!-- 导航类型布局 -->
        <ng-container *ngIf="isNavigationCategory(); else financeOrWeatherLayout">
          <div class="navigation-layout">
            <app-knowledge-navigation></app-knowledge-navigation>
          </div>
        </ng-container>
        
        <!-- 财经或天气或日历或新闻或默认布局 -->
        <ng-template #financeOrWeatherLayout>
          <!-- 财经类型布局 -->
          <ng-container *ngIf="isFinanceCategory(); else weatherOrCalendarLayout">
            <div class="finance-layout">
              <app-knowledge-finance></app-knowledge-finance>
            </div>
          </ng-container>
          
          <!-- 天气或日历或新闻或默认布局 -->
          <ng-template #weatherOrCalendarLayout>
            <!-- 天气类型布局 -->
            <ng-container *ngIf="isWeatherCategory(); else calendarOrNewsLayout">
              <div class="weather-layout">
                <app-knowledge-weather></app-knowledge-weather>
              </div>
            </ng-container>
            
            <!-- 日历或新闻或默认布局 -->
            <ng-template #calendarOrNewsLayout>
              <!-- 日历类型布局 -->
              <ng-container *ngIf="isCalendarCategory(); else newsOrDefaultLayout">
                <div class="calendar-layout">
                  <app-knowledge-calendar 
                    [events]="calendarEvents"
                    (dateSelected)="onDateSelected($event)">
                  </app-knowledge-calendar>
                </div>
              </ng-container>

              <!-- 新闻或默认布局 -->
              <ng-template #newsOrDefaultLayout>
                <!-- 资讯类型及其子类型使用三栏布局 -->
                <ng-container *ngIf="isNewsCategory(); else defaultLayout">
                  <app-knowledge-news 
                    [entities]="entities" 
                    [selectedCategory]="selectedCategory"
                    [onScrollEntity]="onScrollEntity.bind(this)">
                  </app-knowledge-news>
                </ng-container>

                <!-- 默认布局 -->
                <ng-template #defaultLayout>
                  <div class="content" infiniteScroll [infiniteScrollDistance]="2" [infiniteScrollThrottle]="50"
                    (scrolled)="onScrollEntity()">
                    <div class="news-grid">
                      <!-- 其它类型整体渲染 -->
                      <div *ngFor="let entity of entities" class="news-card" [style.grid-column]="getCardWidth(entity)">
                        <!-- 视频内容 -->
                        <div *ngIf="entity['_source']?.videos?.length > 0" class="thumbnail-container">
                          <a [routerLink]="'/start/search/info/' + entity._id">
                            <img [src]="'data:image/jpeg;base64,' + entity['_source']?.videos[0].thumbnail" class="thumbnail"
                              loading="lazy" style="width: 100%; border-radius: 4px" />
                            <div class="play-icon">
                              <i class="fas fa-play"></i>
                            </div>
                            <div class="video-duration">
                              {{ entity["_source"]?.videos[0].duration || "00:00" }}
                            </div>
                          </a>
                          <div class="overlay-text">
                            <h3 [routerLink]="'/start/search/info/' + entity._id">
                              {{ entity["_source"]?.labels?.zh?.value | slice:0:25 }}
                              {{ entity["_source"]?.labels?.zh?.value.length > 25 ? "..." : "" }}
                            </h3>
                            <p>{{ entity["_source"]?.descriptions?.zh?.value || "No description available." }}</p>
                          </div>
                        </div>

                        <!-- 文档内容 -->
                        <div *ngIf="entity['_source']?.documents?.length > 0" class="thumbnail-container">
                          <a [routerLink]="'/start/search/info/' + entity._id">
                            <img [src]="entity['_source']?.documents[0].thumbnail" class="thumbnail" loading="lazy"
                              style="width: 100%; border-radius: 4px" />
                          </a>
                          <div class="overlay-text">
                            <h3 [routerLink]="'/start/search/info/' + entity._id">
                              {{ entity["_source"]?.labels?.zh?.value | slice:0:25 }}
                              {{ entity["_source"]?.labels?.zh?.value.length > 25 ? "..." : "" }}
                            </h3>
                            <p>{{ entity["_source"]?.descriptions?.zh?.value || "No description available." }}</p>
                          </div>
                        </div>

                        <!-- 图片内容 -->
                        <div *ngIf="!entity['_source']?.documents && !entity['_source']?.videos">
                          <img [routerLink]="'/start/search/info/' + entity._id" class="image"
                            *ngFor="let image of entity['_source']?.images?.slice(0, 1)"
                            [src]="image.startsWith('http') ? image : 'http://'+ip+':9000/kgms/' + image" loading="lazy"
                            style="width: 100%; border-radius: 4px; margin-bottom: 12px" />
                          <h3 [routerLink]="'/start/search/info/' + entity._id">
                            {{ entity["_source"]?.labels?.zh?.value | slice:0:25 }}
                            {{ entity["_source"]?.labels?.zh?.value.length > 25 ? "..." : "" }}
                          </h3>
                          <p>{{ entity["_source"]?.descriptions?.zh?.value || "No description available." }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-template>
              </ng-template>
            </ng-template>
          </ng-template>
        </ng-template>
      </ng-template>
    </ng-template>
  </ng-template>
</div>