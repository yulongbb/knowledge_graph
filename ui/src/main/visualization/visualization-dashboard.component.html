<div class="dashboard-title-bar">
  <h2>{{ appName }}</h2>
  <button class="preview-btn" (click)="showPreview()">预览</button>
</div>
<div class="dashboard-container">
    <div class="sidebar-nav">
        <button [class.active]="activeSidebar === 'layer'" (click)="setSidebar('layer')">图层</button>
        <button [class.active]="activeSidebar === 'component'" (click)="setSidebar('component')">组件库</button>
        <button [class.active]="activeSidebar === 'design'" (click)="setSidebar('design')">设计库</button>
        <button [class.active]="activeSidebar === 'template'" (click)="setSidebar('template')">模板库</button>
        <button [class.active]="activeSidebar === 'resource'" (click)="setSidebar('resource')">资源</button>
    </div>
    <div class="side-panel">
        <div *ngIf="activeSidebar === 'layer'" class="layer-panel">
            <div>图层管理</div>
            <ul>
                <li *ngFor="let layer of layers; let i = index" [class.active]="activeLayerIndex === i"
                    (click)="setActiveLayer(i)">
                    图层{{i + 1}}
                    <button (click)="removeLayer(i); $event.stopPropagation();"
                        [disabled]="layers.length <= 1">删除</button>
                </li>
            </ul>
            <button (click)="addLayer()">添加图层</button>
        </div>
        <div *ngIf="activeSidebar === 'component'" class="component-lib">
            <div>组件库内容</div>
            <div class="component-preview-list">
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('echarts-bar')"
                     (dragend)="onPaletteDragEnd($event)"
                     (mouseenter)="onPreviewChartHover('bar')">
                    <svg width="48" height="48">
                        <rect x="12" y="30" width="4" height="8" fill="#1976d2" />
                        <rect x="20" y="24" width="4" height="14" fill="#1976d2" />
                        <rect x="28" y="18" width="4" height="20" fill="#1976d2" />
                    </svg>
                    <div class="preview-label">柱状图</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('echarts-pie')"
                     (dragend)="onPaletteDragEnd($event)"
                     (mouseenter)="onPreviewChartHover('pie')">
                    <svg width="48" height="48">
                        <circle cx="24" cy="24" r="20" fill="#eee" stroke="#1976d2" stroke-width="2" />
                        <path d="M24,24 L44,24 A20,20 0 0,1 24,44 Z" fill="#1976d2" />
                        <path d="M24,24 L24,4 A20,20 0 0,1 44,24 Z" fill="#ff9800" />
                    </svg>
                    <div class="preview-label">饼图</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('echarts-radar')"
                     (dragend)="onPaletteDragEnd($event)"
                     (mouseenter)="onPreviewChartHover('radar')">
                    <svg width="48" height="48">
                        <polygon points="24,8 40,24 32,40 16,40 8,24" fill="#e3eaf2" stroke="#1976d2"
                            stroke-width="2" />
                        <polygon points="24,16 34,24 30,34 18,34 14,24" fill="#1976d2" opacity="0.5" />
                    </svg>
                    <div class="preview-label">雷达图</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('echarts-wordcloud')"
                     (dragend)="onPaletteDragEnd($event)"
                     (mouseenter)="onPreviewChartHover('wordcloud')">
                    <svg width="48" height="48">
                        <rect x="4" y="12" width="40" height="24" fill="#fff" stroke="#1976d2" stroke-width="1" />
                        <text x="24" y="28" text-anchor="middle" font-size="12" fill="#1976d2">词云</text>
                    </svg>
                    <div class="preview-label">词云</div>
                </div>
            </div>
            <!-- 可在此处添加图表预览 -->
            <div style="width:100px;height:60px;margin-top:8px;">
                <ngx-echarts [options]="echartsPreviewOption"></ngx-echarts>
            </div>
        </div>
        <div *ngIf="activeSidebar === 'template'" class="template-lib">
            模板库内容
        </div>
        <div *ngIf="activeSidebar === 'resource'" class="resource-lib">
            资源内容
        </div>
        <div *ngIf="activeSidebar === 'design'" class="design-lib">
            <div>设计库</div>
            <div class="component-preview-list">
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('text')"
                     (dragend)="onPaletteDragEnd($event)">
                    <svg width="48" height="48">
                        <text x="24" y="32" text-anchor="middle" font-size="28" fill="#1976d2" font-family="Arial">T</text>
                    </svg>
                    <div class="preview-label">文字</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('rect')"
                     (dragend)="onPaletteDragEnd($event)">
                    <svg width="48" height="48">
                        <rect x="8" y="12" width="32" height="24" fill="#e3eaf2" stroke="#1976d2" stroke-width="2"/>
                    </svg>
                    <div class="preview-label">矩形</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('circle')"
                     (dragend)="onPaletteDragEnd($event)">
                    <svg width="48" height="48">
                        <circle cx="24" cy="24" r="14" fill="#e3eaf2" stroke="#1976d2" stroke-width="2"/>
                    </svg>
                    <div class="preview-label">圆形</div>
                </div>
                <div class="component-preview-item"
                     draggable="true"
                     (dragstart)="onPaletteDragStart('line')"
                     (dragend)="onPaletteDragEnd($event)">
                    <svg width="48" height="48">
                        <line x1="8" y1="40" x2="40" y2="8" stroke="#1976d2" stroke-width="3"/>
                    </svg>
                    <div class="preview-label">直线</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 中间画布区域（参考 panel.component.html） -->
    <div class="canvas-container">
      <div class="canvas-header">
        <div class="header-left">
          <h3>可视化大屏设计器</h3>
          <div class="canvas-info">拖拽组件到画布进行设计</div>
        </div>
        <div class="header-actions">
          <button class="action-btn secondary" (click)="clearCanvas()">清空画布</button>
          <button class="action-btn secondary" (click)="previewCanvas()">预览</button>
          <button class="action-btn primary" (click)="saveDesign()">保存</button>
        </div>
      </div>
      <div class="canvas-wrapper">
        <!-- 浮动工具栏 -->
        <div class="canvas-toolbar">
          <div class="toolbar-group">
            <button class="toolbar-btn" (click)="zoomOut()" title="缩小">-</button>
            <span class="zoom-display">{{ getZoomPercent() }}%</span>
            <button class="toolbar-btn" (click)="zoomIn()" title="放大">+</button>
          </div>
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <button class="toolbar-btn" (click)="resetCanvas()" title="重置视图">⌂</button>
            <button class="toolbar-btn" (click)="fitToContainerWidth()" title="适应宽度">⟷</button>
            <button class="toolbar-btn" (click)="fitToScreen()" title="适应屏幕">□</button>
          </div>
        </div>
        <!-- Konva 画布容器 -->
        <div
          class="canvas"
          [ngStyle]="getCanvasStyle()"
          (mousedown)="onCanvasMouseDown($event)"
          (mousemove)="onCanvasMouseMove($event)"
          (mouseup)="onCanvasMouseUp($event)"
          (mouseleave)="onCanvasMouseUp($event)"
          (wheel)="onCanvasWheel($event)"
          (drop)="onCanvasDrop($event)"
          (dragover)="onCanvasDragOver($event)"
        >
          <div #canvasContainer style="width:100%;height:100%;"></div>
        </div>
      </div>
      <!-- 画布底部信息栏/标签页（可选，按需实现） -->
      <!--
      <div class="canvas-footer">
        <div class="canvas-tabs">
          <div class="canvas-tab active">画布1</div>
          <button class="add-canvas-btn">+</button>
        </div>
      </div>
      -->
    </div>
    <div class="component-palette">
        <div>Palette</div>
        <!-- 按钮已移到组件库，不再显示 -->
        <div *ngIf="selectedNode || selectedEchartsId" class="style-editor">
            <div>样式编辑</div>
            <!-- 层级操作按钮，支持 Konva 元素和 ECharts 图表 -->
            <div class="zindex-toolbar">
                <button type="button" (click)="moveSelectedUp()">上移一层</button>
                <button type="button" (click)="moveSelectedDown()">下移一层</button>
                <button type="button" (click)="moveSelectedToTop()">置顶</button>
                <button type="button" (click)="moveSelectedToBottom()">置底</button>
            </div>
            <!-- 图表数据编辑 -->
            <div *ngIf="selectedChartData">
                <div *ngIf="selectedChartData.type === 'bar'">
                    <label>横轴数据（逗号分隔）:
                        <input type="text" [(ngModel)]="selectedChartData.data.xAxis" />
                    </label>
                    <label>柱状数据（逗号分隔）:
                        <input type="text" [(ngModel)]="selectedChartData.data.series" />
                    </label>
                </div>
                <div *ngIf="selectedChartData.type === 'pie'">
                    <label *ngFor="let item of selectedChartData.data.data; let i = index">
                        名称: <input type="text" [(ngModel)]="item.name" style="width:60px;" />
                        数值: <input type="number" [(ngModel)]="item.value" style="width:60px;" />
                    </label>
                </div>
                <div *ngIf="selectedChartData.type === 'radar'">
                    <label *ngFor="let ind of selectedChartData.data.indicator; let i = index">
                        指标名: <input type="text" [(ngModel)]="ind.name" style="width:60px;" />
                        最大值: <input type="number" [(ngModel)]="ind.max" style="width:60px;" />
                    </label>
                    <label>得分（逗号分隔）:
                        <input type="text" [(ngModel)]="selectedChartData.data.value" />
                    </label>
                </div>
                <div *ngIf="selectedChartData.type === 'wordcloud'">
                    <label *ngFor="let item of selectedChartData.data.data; let i = index">
                        词: <input type="text" [(ngModel)]="item.name" style="width:60px;" />
                        权重: <input type="number" [(ngModel)]="item.value" style="width:60px;" />
                    </label>
                </div>
                <button type="button" (click)="onChartDataSave()">保存</button>
            </div>
            <!-- 图表代码编辑 -->
            <div *ngIf="selectedChartData">
                <div style="margin-bottom:8px;">
                    <label>option代码（直接编辑ECharts配置）:</label>
                    <textarea [(ngModel)]="chartOptionCode" rows="12" style="width:100%;font-family:monospace;font-size:13px;"></textarea>
                </div>
                <button type="button" (click)="onChartOptionCodeSave()">保存</button>
            </div>
            <!-- 圆形/环形/自定义形状 -->
            <div
                *ngIf="selectedNode && (selectedNode.getClassName() === 'Circle' || selectedNode.getClassName() === 'Ring' || selectedNode.getClassName() === 'Shape')">
                <label>填充色:
                    <input type="color" [value]="getNodeFill(selectedNode)" (input)="updateNodeStyle('fill', $event)" />
                </label>
                <label>描边色:
                    <input type="color" [value]="getNodeStroke(selectedNode)"
                        (input)="updateNodeStyle('stroke', $event)" />
                </label>
                <label>描边宽:
                    <input type="number" [value]="getNodeStrokeWidth(selectedNode)" min="0"
                        (input)="updateNodeStyle('strokeWidth', $event)" />
                </label>
            </div>
            <!-- 标签 -->
            <div *ngIf="selectedNode && selectedNode.getClassName() === 'Label'">
                <label>字体颜色:
                    <input type="color" [value]="getLabelTextFill()" (input)="updateLabelTextStyle('fill', $event)" />
                </label>
                <label>字体大小:
                    <input type="number" [value]="getLabelTextFontSize()" min="8"
                        (input)="updateLabelTextStyle('fontSize', $event)" />
                </label>
                <label>文本:
                    <input type="text" [value]="getLabelText()" (input)="updateLabelTextStyle('text', $event)" />
                </label>
            </div>
            <!-- 图片 -->
            <div *ngIf="selectedNode && selectedNode.getClassName() === 'Image'">
                <label>图片地址:
                    <input type="text" [value]="getImageSrc()" (change)="onImageSrcChange($event)" />
                </label>
            </div>
        </div>
    </div>
</div>
<!-- 预览弹窗部分已正确集成 CanvasPreviewComponent -->